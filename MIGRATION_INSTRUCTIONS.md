# Инструкция по применению миграции

## Проблема
Получаете ошибки:
- `406 (Not Acceptable)` для запроса к таблице `couples`
- `404 (Not Found)` для функции `join_couple_by_invite_code`

## Решение

### Шаг 1: Применить миграцию в Supabase Dashboard

1. Откройте [Supabase Dashboard](https://supabase.com/dashboard)
2. Выберите ваш проект
3. Перейдите в раздел **SQL Editor**
4. Скопируйте содержимое файла `apply-migration.sql`
5. Вставьте код в SQL Editor
6. Нажмите **Run** для выполнения

### Шаг 2: Проверить результат

После применения миграции должны быть исправлены:

1. **RLS политики** - теперь пользователи могут искать пары по коду приглашения
2. **Структура таблицы** - `partner2_id` теперь может быть NULL
3. **Функции** - добавлены `find_couple_by_invite_code` и `join_couple_by_invite_code`

### Шаг 3: Тестирование

После применения миграции протестируйте:

1. **Создание кода приглашения** - должно работать без ошибок
2. **Присоединение по коду** - должно работать с новой функцией
3. **Проверка статуса пары** - должно корректно отображать статус

## Что было исправлено

### RLS Политики
- Удалена ограничительная политика `"Users can view their couples"`
- Добавлена новая политика `"Users can view their couples or search by invite code"`
- Теперь пользователи могут искать пары по `invite_code` даже если они не являются участниками

### Структура таблицы
- `partner2_id` теперь может быть NULL (изначально)
- Удален UNIQUE constraint на `(partner1_id, partner2_id)`
- Добавлен новый индекс для активных пар с разными партнерами

### Функции
- `find_couple_by_invite_code()` - безопасный поиск пары по коду
- `join_couple_by_invite_code()` - безопасное присоединение к паре
- Обе функции имеют правильные права доступа

### Код приложения
- Обновлены TypeScript типы для поддержки NULL `partner2_id`
- Исправлена логика создания пары (теперь `partner2_id` = NULL)
- Улучшена проверка статуса пары
